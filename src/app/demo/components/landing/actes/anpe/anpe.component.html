<div class="surface-0">
    <div class="guide-wrapper overflow-hidden">
        <app-header></app-header>  
        <!-- Hero Section avec progression -->
        <div class="bg-green-800 text-white px-4 py-8 md:px-6 lg:px-8">
            <div class="text-center">
                <h1 class="text-5xl font-bold mb-4">Formulaire de demande d'une attestation ANPE</h1>
                <div class="text-lg mb-4">Étape {{currentStep + 1}} sur {{items.length}}</div>
                <!-- <p-progressBar [value]="(currentStep + 1) / items.length * 100"></p-progressBar> -->
                <p-progressBar [value]="progressValue"></p-progressBar>
            </div>
        </div>         
        <div class="px-4 py-8 md:px-6 lg:px-8">
            <p-toast position="top-right"></p-toast>
            <p-steps [model]="items" [activeIndex]="currentStep" 
            [readonly]="false" (activeIndexChange)="onStepChange($event)"></p-steps>
            
            
            <div class="mt-4">
                <p-card>
                    <form (ngSubmit)="onSubmit()" #anpeForm="ngForm">
                        <!-- Step 1: Informations du contrat -->
                        <div [hidden]="currentStep !== 0">
                            <p-fieldset legend="Informations du contrat">
                                <div class="p-fluid p-formgrid grid">
                                    <div class="col-4 mt-2">
                                        <span>Reference du contrat</span>
                                        <input [(ngModel)]="formData.contractReference" name="contractReference" pInputText required />
                                    </div>
                                    <div class="col-8 mt-2">
                                        <span>Objet du contrat</span>
                                        <input [(ngModel)]="formData.contractPurpose" name="contractPurpose" pInputText required />
                                    </div>
                                    <div class="col-5 mt-2">
                                        <span>Identité de l'organisme attribuant le marché</span>
                                        <input [(ngModel)]="formData.contractingOrganizationName" name="contractingOrganizationName" pInputText required />
                                    </div>
                                    <div class="col-4 mt-2">
                                        <span>Adresse</span>
                                        <input [(ngModel)]="formData.organizationAddress" name="organizationAddress" pInputText required />
                                    </div>
                                    <div class="col-3 mt-2">
                                        <span>Numéro de téléphone</span>
                                        <input [(ngModel)]="formData.organizationPhone" name="organizationPhone" pInputText required />
                                    </div>
                                </div>
                            </p-fieldset>
                        </div>

                        <!-- Step 2: Situation de l'employeur -->
                        <div [hidden]="currentStep !== 1">
                            <p-fieldset legend="Déclaration de la situation de l'employeur">
                                <div class="p-fluid p-formgrid grid">
                                    <div class="col-2 mt-2">
                                        <span>Numéro d'identification</span>
                                        <input [(ngModel)]="formData.employerIdentification" name="employerIdentification" pInputText required />
                                    </div>
                                    <div class="col-3 mt-2">
                                        <span>Secteur d'activité</span>
                                        <input [(ngModel)]="formData.activitySector" name="activitySector" pInputText required />
                                    </div>
                                    <div class="col-3 mt-2">
                                        <span>Province</span>
                                        <input [(ngModel)]="formData.province" name="province" pInputText required />
                                    </div>
                                    <div class="col-2 mt-2">
                                        <span>Commune</span>
                                        <input [(ngModel)]="formData.commune" name="commune" pInputText required />
                                    </div>
                                    <div class="col-2 mt-2">
                                        <span>Rue</span>
                                        <input [(ngModel)]="formData.street" name="street" pInputText required />
                                    </div>
                                    
                                </div>
                            </p-fieldset>
                        </div>

                        <!-- Step 3: Renseignements sur l'établissement -->
                        <div [hidden]="currentStep !== 2">
                            <p-fieldset legend="Identification de l'établissement">
                                <div class="p-fluid p-formgrid grid">
                                    <div class="col-6 mt-2">
                                        <span>Dénomination de l'établissement</span>
                                        <input [(ngModel)]="formData.establishmentName" name="establishmentName" pInputText required />
                                    </div>
                                    <div class="col-3 mt-2">
                                        <span>Nom du responsable</span>
                                        <input [(ngModel)]="formData.managerLastName" name="managerLastName" pInputText required />
                                    </div>
                                    <div class="col-3 mt-2">
                                        <span>Prénom du responsable</span>
                                        <input [(ngModel)]="formData.managerFirstName" name="managerFirstName" pInputText required />
                                    </div>
                                    <div class="col-3 mt-2">
                                        <span>Date d'ouverture</span>
                                        <p-calendar [(ngModel)]="formData.openingDate" name="openingDate" [showIcon]="true" required></p-calendar>
                                    </div>
                                    <div class="col-3 mt-2">
                                        <span>Numéro d'adhérent CNSS</span>
                                        <input [(ngModel)]="formData.cnssNumber" name="cnssNumber" pInputText required />
                                    </div>
                                    <div class="col-3 mt-2">
                                        <span>Activité principale</span>
                                        <input [(ngModel)]="formData.mainActivity" name="mainActivity" pInputText required />
                                    </div>
                                    <div class="col-3 mt-2">
                                        <span>Activité secondaire</span>
                                        <input [(ngModel)]="formData.secondaryActivity" name="secondaryActivity" pInputText />
                                    </div>
                                </div>
                            </p-fieldset>

                            <p-fieldset legend="Effectifs" class="mt-3">
                                <div class="p-fluid p-formgrid grid">
                                    <div class="col-6 mt-2">
                                        <span>Travailleurs permanents</span>
                                        <p-inputNumber [(ngModel)]="formData.permanentWorkers" name="permanentWorkers" required></p-inputNumber>
                                    </div>
                                    <div class="col-6 mt-2">
                                        <span>Travailleurs temporaires</span>
                                        <p-inputNumber [(ngModel)]="formData.temporaryWorkers" name="temporaryWorkers" required></p-inputNumber>
                                    </div>
                                    <div class="col-3 mt-2">
                                        <span>Apprentis en poste</span>
                                        <p-inputNumber [(ngModel)]="formData.apprentices" name="apprentices" required></p-inputNumber>
                                    </div>
                                    <div class="col-3 mt-2">
                                        <span>Apprentis en poste acceptés</span>
                                        <p-inputNumber [(ngModel)]="formData.accepted_apprentices" name="accepted_apprentices" required></p-inputNumber>
                                    </div>
                                    <div class="col-3 mt-2">
                                        <span>Stagiaires en poste</span>
                                        <p-inputNumber [(ngModel)]="formData.interns" name="interns" required></p-inputNumber>
                                    </div>
                                    <div class="col-3 mt-2">
                                        <span>Stagiaires en poste accepté</span>
                                        <p-inputNumber [(ngModel)]="formData.accepted_interns" name="accepted_interns" required></p-inputNumber>
                                    </div>
                                </div>
                            </p-fieldset>

                            <p-fieldset legend="Périodes d'emploi" class="mt-3">
                                <div class="p-fluid p-formgrid grid">
                                    <div class="col-6">
                                        <h4>Période de plein emploi</h4>
                                        <div class="grid">
                                            <div class="col-6">
                                                <span>De</span>
                                                <p-calendar [(ngModel)]="formData.fullEmploymentStart" name="fullEmploymentStart" [showIcon]="true"></p-calendar>
                                            </div>
                                            <div class="col-6">
                                                <span>À</span>
                                                <p-calendar [(ngModel)]="formData.fullEmploymentEnd" name="fullEmploymentEnd" [showIcon]="true"></p-calendar>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <h4>Période de baisse d'emploi</h4>
                                        <div class="grid">
                                            <div class="col-6">
                                                <span>De</span>
                                                <p-calendar [(ngModel)]="formData.lowEmploymentStart" name="lowEmploymentStart" [showIcon]="true"></p-calendar>
                                            </div>
                                            <div class="col-6">
                                                <span>À</span>
                                                <p-calendar [(ngModel)]="formData.lowEmploymentEnd" name="lowEmploymentEnd" [showIcon]="true"></p-calendar>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </p-fieldset>
                        </div>

                        <!-- Step 4: Intentions et besoins -->
                        <div [hidden]="currentStep !== 3">
                            <p-fieldset legend="Intentions de l'établissement">
                                <div class="p-fluid p-formgrid grid">
                                    <div class="col-8">
                                        <h4>Renforcement d'effectifs</h4>
                                        <div class="grid">
                                            <div class="col-6">
                                                <span>Pour l'année en cours</span>
                                                <p-selectButton [options]="yesNoOptions" [(ngModel)]="formData.currentYearRecruitment" name="currentYearRecruitment" optionLabel="label" optionValue="value"></p-selectButton>
                                            </div>
                                            <div class="col-6">
                                                <span>Pour l'année à venir</span>
                                                <p-selectButton [options]="yesNoOptions" [(ngModel)]="formData.nextYearRecruitment" name="nextYearRecruitment" optionLabel="label" optionValue="value"></p-selectButton>
                                            </div>
                                        </div>
                                    </div>
                                    <br/>
                                    <div class="col-8">
                                        <h4>Compression d'effectifs</h4>
                                        <p-selectButton [options]="yesNoOptions" [(ngModel)]="formData.staffReduction" name="staffReduction" optionLabel="label" optionValue="value"></p-selectButton>
                                    </div>
                                </div>
                            </p-fieldset>

                            <p-fieldset legend="Besoins en formation" class="mt-3">
                                <div class="p-fluid p-formgrid grid">
                                    <div class="col-8">
                                        <span>Domaine</span>
                                        <input [(ngModel)]="formData.trainingDomain" name="trainingDomain" pInputText />
                                    </div>
                                    <div class="col-4">
                                        <span>Nombre à former</span>
                                        <p-inputNumber [(ngModel)]="formData.trainingCount" name="trainingCount"></p-inputNumber>
                                    </div>
                                </div>
                            </p-fieldset>

                            <p-fieldset legend="Besoins en perfectionnement" class="mt-3">
                                <div class="p-fluid p-formgrid grid">
                                    <div class="col-8">
                                        <span>Modules</span>
                                        <input [(ngModel)]="formData.perfectionnementModules" name="perfectionnementModules" pInputText />
                                    </div>
                                    <div class="col-4">
                                        <span>Nombre de participants</span>
                                        <p-inputNumber [(ngModel)]="formData.perfectionnementCount" name="perfectionnementCount"></p-inputNumber>
                                    </div>
                                </div>
                            </p-fieldset>

                            <p-fieldset legend="Attentes de l'ANPE" class="mt-3">
                                <div class="p-fluid">
                                    <span>Quelles actions précises attendez-vous de l'ANPE?</span>
                                    <textarea [(ngModel)]="formData.anpeExpectations" name="anpeExpectations" pInputTextarea rows="5"></textarea>
                                </div>
                            </p-fieldset>
                        </div>

                        <!-- Step 5: Documents -->
                        <div [hidden]="currentStep !== 4">
                            <p-fieldset legend="Documents requis">
                                <div class="p-fluid p-formgrid grid">
                                    <div *ngFor="let doc of requiredDocuments" class="field col-12 md:col-6">
                                        <div class="flex flex-column gap-2">
                                            <label>{{doc.label}}</label>
                                            <div class="upload-container">
                                                <p-fileUpload 
                                                    #fileUpload
                                                    mode="advanced" 
                                                    [showUploadButton]="false"
                                                    [showCancelButton]="false"
                                                    [maxFileSize]="5000000"
                                                    [customUpload]="true"
                                                    (onSelect)="onFileSelect($event, doc.key)"
                                                    accept="image/*,.pdf"
                                                    [auto]="true"
                                                    styleClass="w-full"
                                                    chooseLabel="Sélectionner {{doc.label}}"
                                                    invalidFileSizeMessageSummary="{0}: Taille de fichier invalide, "
                                                    invalidFileSizeMessageDetail="la taille maximale est {0}."
                                                    invalidFileTypeMessageSummary="{0}: Type de fichier invalide, "
                                                    invalidFileTypeMessageDetail="seuls les types {0} sont autorisés.">
                                                    <ng-template pTemplate="content">
                                                        <div *ngIf="uploadedFiles[doc.key]" class="flex align-items-center gap-2 mt-2">
                                                            <i class="pi pi-file text-primary"></i>
                                                            <span>{{uploadedFiles[doc.key].name}}</span>
                                                            <button pButton type="button" icon="pi pi-times" 
                                                                    class="p-button-rounded p-button-danger p-button-text"
                                                                    (click)="removeFile(doc.key)"></button>
                                                        </div>
                                                    </ng-template>
                                                </p-fileUpload>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </p-fieldset>
                        </div>


                         <!-- Nouvelle étape : Récapitulatif -->
                         <div [hidden]="currentStep !== 5">
                            <p-fieldset legend="Récapitulatif de votre demande">
                                <div class="grid">
                                    <!-- Informations du contrat -->
                                    <div class="col-12 md:col-6">
                                        <p-panel header="Informations du contrat" styleClass="mb-3">
                                            <div class="flex flex-column gap-2">
                                                <div class="flex justify-content-between">
                                                    <span class="font-semibold">Référence:</span>
                                                    <span>{{formData.contractReference}}</span>
                                                </div>
                                                <div class="flex justify-content-between">
                                                    <span class="font-semibold">Objet:</span>
                                                    <span>{{formData.contractPurpose}}</span>
                                                </div>
                                                <div class="flex justify-content-between">
                                                    <span class="font-semibold">Organisme:</span>
                                                    <span>{{formData.contractingOrganizationName}}</span>
                                                </div>
                                            </div>
                                        </p-panel>
                                    </div>

                                    <!-- Situation de l'employeur -->
                                    <div class="col-12 md:col-6">
                                        <p-panel header="Situation de l'employeur" styleClass="mb-3">
                                            <div class="flex flex-column gap-2">
                                                <div class="flex justify-content-between">
                                                    <span class="font-semibold">N° d'identification:</span>
                                                    <span>{{formData.employerIdentification}}</span>
                                                </div>
                                                <div class="flex justify-content-between">
                                                    <span class="font-semibold">Localisation:</span>
                                                    <span>{{formData.province}}, {{formData.commune}}</span>
                                                </div>
                                                <div class="flex justify-content-between">
                                                    <span class="font-semibold">Secteur:</span>
                                                    <span>{{formData.activitySector}}</span>
                                                </div>
                                            </div>
                                        </p-panel>
                                    </div>

                                    <!-- Données de l'établissement -->
                                    <div class="col-12">
                                        <p-panel header="Statistiques de l'établissement" styleClass="mb-3">
                                            <div class="grid">
                                                <div class="col-12 md:col-6">
                                                    <h4>Effectifs</h4>
                                                    <p-chart type="pie" [data]="getEffectifsChartData()" 
                                                            [options]="chartOptions" width="300px"></p-chart>
                                                </div>
                                                <div class="col-12 md:col-6">
                                                    <h4>Intentions de recrutement</h4>
                                                    <div class="flex flex-column gap-3 mt-3">
                                                        <div class="flex align-items-center gap-2">
                                                            <i [class]="formData.currentYearRecruitment ? 'pi pi-check-circle text-green-500' : 'pi pi-times-circle text-red-500'"></i>
                                                            <span>Recrutement année en cours</span>
                                                        </div>
                                                        <div class="flex align-items-center gap-2">
                                                            <i [class]="formData.nextYearRecruitment ? 'pi pi-check-circle text-green-500' : 'pi pi-times-circle text-red-500'"></i>
                                                            <span>Recrutement année prochaine</span>
                                                        </div>
                                                        <div class="flex align-items-center gap-2">
                                                            <i [class]="formData.staffReduction ? 'pi pi-check-circle text-green-500' : 'pi pi-times-circle text-red-500'"></i>
                                                            <span>Compression d'effectifs</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </p-panel>
                                    </div>

                                    <!-- Documents soumis -->
                                    <div class="col-12">
                                        <p-panel header="Documents soumis" styleClass="mb-3">
                                            <div class="grid">
                                                <div *ngFor="let doc of requiredDocuments" class="col-12 md:col-4">
                                                    <div class="flex align-items-center gap-2">
                                                        <i [class]="uploadedFiles[doc.key] ? 'pi pi-check-circle text-green-500' : 'pi pi-times-circle text-red-500'"></i>
                                                        <span>{{doc.label}}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </p-panel>
                                    </div>
                                </div>

                                <!-- Message de confirmation -->
                                <div class="mt-4 p-3 surface-100 border-round">
                                    <div class="flex align-items-center gap-2">
                                        <i class="pi pi-info-circle text-primary"></i>
                                        <span>Veuillez vérifier toutes les informations avant la soumission finale. 
                                              Une fois soumis, le formulaire ne pourra plus être modifié.</span>
                                    </div>
                                </div>
                            </p-fieldset>
                        </div>

                        <!-- Navigation buttons avec sauvegarde -->
                        <div class="flex justify-content-between mt-4">
                            <div>
                                <button 
                                    pButton 
                                    type="button"
                                    label="Précédent" 
                                    icon="pi pi-chevron-left"
                                    class="p-button-secondary" 
                                    [disabled]="currentStep === 0"
                                    (click)="prevStep()">
                                </button>
                            </div>

                            <div>
                                <button 
                                    *ngIf="currentStep < 5"
                                    pButton 
                                    type="button"
                                    label="Sauvegarder"
                                    icon="pi pi-save"
                                    class="p-button-info mr-2"
                                    (click)="saveProgress()">
                                </button>

                                <button 
                                    pButton 
                                    type="button"
                                    [label]="currentStep === 4 ? 'Voir récapitulatif' : 'Suivant'"
                                    [icon]="currentStep === 4 ? 'pi pi-list' : 'pi pi-chevron-right'"
                                    [disabled]="!isStepValid(currentStep)"
                                    (click)="nextStep()"
                                    *ngIf="currentStep !== 5">
                                </button>

                                <p-button
                                    *ngIf="currentStep === 5"
                                    label="Soumettre la demande" 
                                    icon="pi pi-send"
                                    styleClass="p-button-success"
                                    [loading]="submitting"
                                    (onClick)="confirmSubmit()">
                                </p-button>
                            </div>
                        </div>
                    </form>
                </p-card>
            </div>
        </div>
        <app-footer></app-footer>
    </div>
</div>